<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>待辦事項</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    h1 { text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f2f2f2; }
    .btn { padding: 5px 10px; margin: 2px; cursor: pointer; }
    .delete { color: red; }
  </style>
</head>
<body>
  <h1>待辦事項</h1>

  <form id="todoForm">
    日期：<input type="date" id="date" required>
    時間：<input type="time" id="time" required>
    事項：<input type="text" id="task" required>
    <button type="submit">新增</button>
  </form>

  <table id="todoTable">
    <thead>
      <tr>
        <th>日期</th>
        <th>時間</th>
        <th>事項</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx9_LtSOGcOURaNrTd47LN8wN9jBKTuN7seY921RQs/dev"; // 換成你的 Apps Script URL

    async function loadTodos() {
      const res = await fetch(API_URL);
      const data = await res.json();
      const tbody = document.querySelector("#todoTable tbody");
      tbody.innerHTML = "";

      data.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));

      data.forEach(todo => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${todo.date}</td>
          <td>${todo.time}</td>
          <td>${todo.task}</td>
          <td><button class="btn delete" onclick="deleteTodo('${todo.date}','${todo.time}','${todo.task}')">刪除</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById("todoForm").addEventListener("submit", async e => {
      e.preventDefault();
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const task = document.getElementById("task").value;

      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "add", date, time, task })
      });

      e.target.reset();
      loadTodos();
    });

    async function deleteTodo(date, time, task) {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "delete", date, time, task })
      });
      loadTodos();
    }

    // 初始載入
    loadTodos();

    // 提醒功能
    setInterval(async () => {
      const now = new Date();
      const currentDate = now.toISOString().split("T")[0];
      const currentTime = now.toTimeString().slice(0,5);

      const res = await fetch(API_URL);
      const todos = await res.json();

      todos.forEach(todo => {
        if (todo.date === currentDate && todo.time === currentTime) {
          alert("提醒事項：" + todo.task);
          let count = 0;
          const beep = setInterval(() => {
            new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
            count++;
            if (count >= 2) clearInterval(beep);
          }, 1000);
        }
      });
    }, 60000); // 每分鐘檢查一次
  </script>
</body>
</html>
